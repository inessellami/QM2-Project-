library("sp")
library("rgdal")
library("rgeos")
library("tmap")
library(spdep)
library(dplyr)
library("spgwr")



# Load Data
Census.Data <-read.csv("merged.csv")
Output.Areas <- readOGR("USA")

# Merge spatial file and csv file
df <- merge(Output.Areas, Census.Data, by.x="State_Name", by.y="STATE")


# GWR calculation
GWRbandwidth <- gwr.sel(df$abortion ~ df$education + df$religion + df$rep + df$income, data=df,adapt=T)
gwr.model = gwr(df$abortion ~ df$education + df$religion + df$rep + df$income, data = df, adapt=GWRbandwidth, hatmatrix=TRUE, se.fit=TRUE) 
gwr.model
results <-as.data.frame(gwr.model$SDF)
gwr.map<- df
gwr.map@data <- cbind(df@data, as.matrix(results))
qtm(gwr.map, fill = "localR2")

# Mapping variabl coefficents 
map1 <- tm_shape(gwr.map) + tm_fill("df.education", n = 5, style = "quantile", title = "Highschool Dropout Rate Cofficient", palette = "BuGn")+
  tm_layout(frame = TRUE, legend.text.size = 0.5, legend.title.size = 0.6, main.title.position = "center", main.title.size = 1.5) + 
  tm_layout(main.title = "Coefficient for Highschool Dropout Rate") + tm_borders(alpha=.4)

map2 <- tm_shape(gwr.map) + tm_fill("df.income", n = 5, style = "quantile", title = "Median Gousehould Income Coefficient", palette = "BuGn") + 
  tm_layout(frame = TRUE, legend.text.size = 0.5, legend.title.size = 0.6, main.title.position = "center", main.title.size = 1.5) +
  tm_layout(main.title = "Coefficient for Median Household income") + tm_borders(alpha=.4)

map3 <- tm_shape(gwr.map) + tm_fill("df.religion", n = 5, style = "quantile", title = "High Religiousity Coefficient", palette = "BuGn") + 
  tm_layout(frame = TRUE, legend.text.size = 0.5, legend.title.size = 0.6, main.title.position = "center", main.title.size = 1.5) +
  tm_layout(main.title = "Coefficient for High Religiousity Coefficient") + tm_borders(alpha=.4)

map4 <- tm_shape(gwr.map) + tm_fill("df.rep", n = 5, style = "quantile", title = "Percentage of Republican Lean Coefficient", palette = "BuGn") + 
  tm_layout(frame = TRUE, legend.text.size = 0.5, legend.title.size = 0.6, main.title.position = "center", main.title.size = 1.3) +
  tm_layout(main.title = "Coefficient for Percentage of Republican Lean Coefficient") + tm_borders(alpha=.4)


# Output maps
map1
map2
map3 
map4
